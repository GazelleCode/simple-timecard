<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #333;
        }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .btn-group { display: flex; gap: 10px; }
        button { border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; color: white; display: flex; align-items: center; gap: 5px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-refresh { background: var(--primary); }
        .btn-dl { background: #2980b9; }
        #login-area { background: var(--card-bg); padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; max-width: 400px; margin: 80px auto; }
        input, select { padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; margin: 5px 0; }
        #dashboard { display: none; }
        .section { background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--primary); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .status-card { padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #eee; background: #fafafa; }
        .status-card.active { background: #e8f5e9; border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2); }
        .status-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; background: #ccc; color: #666; }
        .status-card.active .status-badge { background: var(--accent); color: white; }
        .status-time { font-size: 0.8rem; color: #888; margin-top: 5px; }
        .filter-bar { display: flex; gap: 15px; align-items: center; background: #eee; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .chart-container { height: 300px; margin-bottom: 20px; display: none; } 
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; color: var(--primary); }
        tr:hover { background: #f1f1f1; }
        .total-row { font-weight: bold; background: #eef; }
        #toast { visibility: hidden; position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 100; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; opacity: 1; top: 30px; }
    </style>
</head>
<body>

    <div id="toast">æ›´æ–°å®Œäº†</div>

    <div class="container">
        <header>
            <div class="header-left">
                <h1>å‹¤æ€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            </div>
            <div class="btn-group" id="header-buttons" style="display:none;">
                <button class="btn-refresh" onclick="refreshData()">ğŸ”„ æœ€æ–°æƒ…å ±ã«æ›´æ–°</button>
                <button class="btn-dl" onclick="downloadCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
            </div>
        </header>

        <div id="login-area">
            <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <br>
            <button class="btn-refresh" onclick="initialLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <div id="dashboard">
            <div class="section">
                <div class="section-header">
                    ç¾åœ¨ã®å‡ºå‹¤çŠ¶æ³
                    <small style="font-size:0.8rem; font-weight:normal; color:#666;">æœ€çµ‚æ›´æ–°: <span id="last-update">-</span></small>
                </div>
                <div id="status-grid" class="status-grid"></div>
            </div>

            <div class="section">
                <div class="section-header">æœˆåˆ¥ãƒ»å€‹äººåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ</div>
                <div class="filter-bar">
                    <div>
                        <label>å¯¾è±¡æœˆ: </label>
                        <input type="month" id="month-picker" onchange="renderReport()">
                    </div>
                    <div>
                        <label>æ°å: </label>
                        <select id="user-picker" onchange="renderReport()">
                            <option value="all">å…¨å“¡è¡¨ç¤ºï¼ˆãƒ­ã‚°ï¼‰</option>
                        </select>
                    </div>
                </div>
                <div id="chart-wrapper" class="chart-container">
                    <canvas id="workChart"></canvas>
                </div>
                <div id="report-container"></div>
            </div>
        </div>
    </div>

    <script>
        // â˜…GASã®URLã¯ãã®ã¾ã¾
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyDv4ESlQTkjdxXH0IhstdPqADHa36179GR3bE1W32YnaYFQkAdh5nvHmxf87-BbgXY/exec"; 

        let rawLogs = []; 
        let myChart = null; 
        let savedPassword = ""; 

        window.onload = () => {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('month-picker').value = `${yyyy}-${mm}`;
        };

        function initialLogin() {
            const pass = document.getElementById('password').value;
            if(!pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            savedPassword = pass;
            fetchData(true);
        }

        function refreshData() {
            if(!savedPassword) return alert("å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
            fetchData(false);
        }

        async function fetchData(isLogin) {
            showToast("ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...", true);
            const btns = document.querySelectorAll('button');
            btns.forEach(b => b.disabled = true);

            try {
                const res = await fetch(GAS_URL + "?t=" + new Date().getTime(), {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getLogs', password: savedPassword })
                });
                const json = await res.json();

                if (json.error) {
                    alert("ã‚¨ãƒ©ãƒ¼: " + json.error);
                } else {
                    // â˜…ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šæ—¥ä»˜å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¼·åŒ–
                    rawLogs = json.logs.slice(1).map(row => ({
                        time: parseJPDate(row[0]), // å°‚ç”¨ã®å¤‰æ›é–¢æ•°ã‚’é€šã™
                        name: row[1],
                        type: row[2]
                    }));
                    rawLogs.sort((a, b) => a.time - b.time);
                    
                    initDashboard();
                    showToast("æ›´æ–°å®Œäº†ï¼");
                }
            } catch (e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); console.error(e);
                showToast("æ›´æ–°å¤±æ•—");
            } finally {
                btns.forEach(b => b.disabled = false);
            }
        }

        // â˜…æ–°è¨­ï¼šæ—¥æœ¬ã®æ—¥ä»˜å½¢å¼ (DD/MM/YYYY) ã‚’æ­£ã—ãè§£é‡ˆã™ã‚‹é–¢æ•°
        function parseJPDate(dateStr) {
            // æ–‡å­—åˆ—ã˜ã‚ƒãªã„ï¼ˆã™ã§ã«Dateå‹ï¼‰ãªã‚‰ãã®ã¾ã¾è¿”ã™
            if (dateStr instanceof Date) return dateStr;

            // "04/01/2026 14:24:03" ã®ã‚ˆã†ãªå½¢å¼ã‹ãƒã‚§ãƒƒã‚¯
            // å½¢å¼: æ•°å­—2æ¡/æ•°å­—2æ¡/æ•°å­—4æ¡ ...
            const match = String(dateStr).match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(.*)$/);
            
            if (match) {
                // match[1] = 04 (æ—¥), match[2] = 01 (æœˆ), match[3] = 2026 (å¹´)
                // JavaScriptæ¨™æº–ã¯ MM/DD/YYYY ãªã®ã§é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã¦ç”Ÿæˆã™ã‚‹
                // "2026/01/04 14:24:03" ã¨ã—ã¦ä½œã‚Šç›´ã™
                return new Date(`${match[3]}/${match[2]}/${match[1]} ${match[4]}`);
            }
            
            // ãã‚Œä»¥å¤–ã®å½¢å¼ãªã‚‰æ™®é€šã«å¤‰æ›
            return new Date(dateStr);
        }

        function initDashboard() {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('header-buttons').style.display = 'flex';
            document.getElementById('last-update').innerText = new Date().toLocaleTimeString();

            updateUserList();
            renderStatusBoard();
            renderReport();
        }

        function showToast(msg, keep=false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            if(!keep) setTimeout(() => t.classList.remove('show'), 3000);
        }

        function renderStatusBoard() {
            const userStatus = {}; 
            rawLogs.forEach(log => {
                userStatus[log.name] = { type: log.type, time: log.time };
            });
            const grid = document.getElementById('status-grid');
            grid.innerHTML = "";
            Object.keys(userStatus).forEach(name => {
                const s = userStatus[name];
                const isWorking = (s.type === 'å‡ºå‹¤');
                const timeStr = formatTime(s.time);
                const div = document.createElement('div');
                div.className = `status-card ${isWorking ? 'active' : ''}`;
                div.innerHTML = `<div class="status-name">${name}</div><div class="status-badge">${isWorking ? 'å‹¤å‹™ä¸­' : 'é€€å‹¤æ¸ˆ'}</div><div class="status-time">Last: ${timeStr}</div>`;
                grid.appendChild(div);
            });
        }

        function updateUserList() {
            const currentVal = document.getElementById('user-picker').value;
            const users = [...new Set(rawLogs.map(l => l.name))];
            const select = document.getElementById('user-picker');
            select.innerHTML = '<option value="all">å…¨å“¡è¡¨ç¤ºï¼ˆãƒ­ã‚°ï¼‰</option>';
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.innerText = u;
                select.appendChild(opt);
            });
            if(currentVal && currentVal !== 'all' && users.includes(currentVal)) {
                select.value = currentVal;
            }
        }

        function renderReport() {
            const selectedMonth = document.getElementById('month-picker').value;
            const selectedUser = document.getElementById('user-picker').value;
            const container = document.getElementById('report-container');
            const chartWrapper = document.getElementById('chart-wrapper');

            if (!selectedMonth) return;
            const [year, month] = selectedMonth.split('-');
            
            // å¹´æœˆã®æ¯”è¼ƒ
            const filteredLogs = rawLogs.filter(l => 
                l.time.getFullYear() == year && 
                (l.time.getMonth() + 1) == parseInt(month)
            );

            if (filteredLogs.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:#888;">${selectedMonth} ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>`;
                chartWrapper.style.display = "none";
                return;
            }

            if (selectedUser !== 'all') {
                chartWrapper.style.display = "block";
                const myLogs = filteredLogs.filter(l => l.name === selectedUser);
                const dailyData = calcDailyWork(myLogs);
                drawChart(dailyData, selectedUser);
                renderPersonalTable(dailyData, selectedUser, container);
            } else {
                chartWrapper.style.display = "none";
                renderAllTable(filteredLogs, container);
            }
        }

        function calcDailyWork(logs) {
            const daily = {};
            logs.forEach(l => {
                const d = l.time.getDate();
                if(!daily[d]) daily[d] = { date: l.time, start: null, end: null };
                if(l.type === 'å‡ºå‹¤' && !daily[d].start) daily[d].start = l.time;
                if(l.type === 'é€€å‹¤') daily[d].end = l.time;
            });
            return daily;
        }

        function drawChart(dailyData, name) {
            const ctx = document.getElementById('workChart').getContext('2d');
            if (myChart) myChart.destroy();

            const days = Object.keys(dailyData).sort((a,b)=>Number(a)-Number(b));
            const plotData = [];

            days.forEach(day => {
                const d = dailyData[day];
                if (d.start) {
                    const startH = d.start.getHours() + d.start.getMinutes()/60;
                    let endH;
                    if (d.end) {
                        endH = d.end.getHours() + d.end.getMinutes()/60;
                    } else {
                        // å‹¤å‹™ä¸­ãªã‚‰ç¾åœ¨æ™‚åˆ»ã¾ã§ä¼¸ã°ã™
                        const now = new Date();
                        if (d.start.getDate() === now.getDate()) {
                             endH = now.getHours() + now.getMinutes()/60;
                        } else {
                             endH = startH + 1; 
                        }
                    }
                    plotData.push({
                        x: day + "æ—¥",
                        y: [startH, endH],
                        status: d.end ? "å®Œäº†" : "å‹¤å‹™ä¸­"
                    });
                }
            });

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: plotData.map(d => d.x),
                    datasets: [{
                        label: 'å‹¤å‹™æ™‚é–“å¸¯',
                        data: plotData,
                        backgroundColor: (ctx) => {
                            const raw = ctx.raw;
                            return (raw && raw.status === "å‹¤å‹™ä¸­") ? 'rgba(231, 76, 60, 0.7)' : 'rgba(39, 174, 96, 0.6)';
                        },
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { min: 0, max: 24, title: { display: true, text: 'æ™‚åˆ»' } }
                    },
                    plugins: {
                        title: { display: true, text: `${name}ã•ã‚“ã®å‹¤å‹™ã‚°ãƒ©ãƒ•` },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const st = ctx.raw.y[0];
                                    const en = ctx.raw.y[1];
                                    const toTime = (h) => Math.floor(h) + ":" + Math.round((h%1)*60).toString().padStart(2,'0');
                                    const status = ctx.raw.status;
                                    return `${toTime(st)} ã€œ ${toTime(en)} (${status})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderPersonalTable(dailyData, name, container) {
            let html = `<h3>è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3><table><thead><tr><th>æ—¥ä»˜</th><th>å‡ºå‹¤</th><th>é€€å‹¤</th><th>å®Ÿåƒ</th></tr></thead><tbody>`;
            let total = 0;
            
            Object.keys(dailyData).sort((a,b)=>Number(a)-Number(b)).forEach(day => {
                const d = dailyData[day];
                let s = "-", e = "-", dur = "-";
                
                if (d.start) s = formatTime(d.start);
                if (d.end) {
                    e = formatTime(d.end);
                    const diff = (d.end - d.start) / (1000*60*60);
                    total += diff;
                    const h = Math.floor(diff);
                    const m = Math.round((diff-h)*60);
                    dur = `${h}æ™‚é–“ ${m}åˆ†`;
                } else if (d.start) {
                    e = "<span style='color:red'>å‹¤å‹™ä¸­</span>";
                }

                html += `<tr><td>${day}æ—¥</td><td>${s}</td><td>${e}</td><td>${dur}</td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="3">åˆè¨ˆ (ç¢ºå®šåˆ†ã®ã¿)</td><td>${total.toFixed(1)} æ™‚é–“</td></tr></tbody></table>`;
            container.innerHTML = html;
        }

        function renderAllTable(logs, container) {
            let html = `<table><thead><tr><th>æ—¥æ™‚</th><th>æ°å</th><th>ç¨®åˆ¥</th></tr></thead><tbody>`;
            logs.forEach(l => {
                html += `<tr><td>${l.time.toLocaleString()}</td><td>${l.name}</td><td>${l.type}</td></tr>`;
            });
            html += "</tbody></table>";
            container.innerHTML = html;
        }

        function formatTime(d) { return d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0'); }
        
        function downloadCSV() {
            let csv = "data:text/csv;charset=utf-8,\uFEFFæ—¥æ™‚,æ°å,ç¨®åˆ¥\n";
            rawLogs.forEach(r => csv += `"${r.time.toLocaleString()}","${r.name}","${r.type}"\n`);
            const a = document.createElement("a");
            a.href = encodeURI(csv); a.download = "timecard.csv"; a.click();
        }
    </script>
</body>
</html>
