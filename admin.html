<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 1.5rem; color: #2c3e50; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-area { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; max-width: 400px; margin: 50px auto; }
        input[type="password"] { padding: 12px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 6px; width: 60%; margin-bottom: 15px; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #dashboard { display: none; }
        .section-title { font-size: 1.2rem; font-weight: bold; margin: 30px 0 15px; border-left: 5px solid #2c3e50; padding-left: 10px; }
        
        /* 1. ç¾åœ¨ã®çŠ¶æ³ãƒ‘ãƒãƒ« */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .user-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; position: relative; border-bottom: 4px solid #ccc; cursor: pointer; transition: transform 0.2s; }
        .user-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .user-card.active { border-bottom-color: #00d26a; }
        .user-card .name { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; }
        .user-card .status { font-size: 0.9rem; color: #888; }
        .user-card.active .status { color: #00d26a; font-weight: bold; }
        .last-time { font-size: 0.8rem; color: #aaa; margin-top: 5px; }

        /* 2. ãƒ¢ãƒ¼ãƒ€ãƒ« (å€‹äººè©³ç´°) */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        #modal-content { background: white; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        #modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #aaa; }
        #modal-close:hover { color: #333; }
        
        .modal-header { display: flex; align-items: baseline; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-name { font-size: 1.8rem; font-weight: bold; }
        .modal-summary { font-size: 1rem; color: #666; }

        .chart-box { height: 300px; width: 100%; }

        /* å…¨ä½“ã‚°ãƒ©ãƒ• */
        .chart-container-main { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 20px; }

        /* ãƒœã‚¿ãƒ³ */
        button { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; }
        button:hover { opacity: 0.9; }
        .btn-download { background: #3498db; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        #loading { display: none; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>å‹¤æ€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <button id="downloadBtn" class="btn-download" style="display:none;" onclick="downloadCSV()">
                <span>ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›</span>
            </button>
        </header>

        <div id="login-area">
            <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <input type="password" id="password" placeholder="Password">
            <br>
            <button onclick="fetchData()">ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
            <div id="loading">å–å¾—ä¸­...</div>
        </div>

        <div id="dashboard">
            <div class="section-title">ç¾åœ¨ã®å‡ºå‹¤çŠ¶æ³ (ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°)</div>
            <div id="status-grid" class="status-grid"></div>

            <div class="section-title">å…¨ä½“ã®æ—¥åˆ¥å‡ºå‹¤è€…æ•°</div>
            <div class="chart-container-main">
                <canvas id="chart-daily"></canvas>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div id="modal-content">
            <span id="modal-close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <div class="modal-name" id="modal-name">æ°å</div>
                <div class="modal-summary" id="modal-summary">ä»Šæœˆã®å‹¤å‹™: --æ™‚é–“</div>
            </div>
            <div class="chart-box">
                <canvas id="chart-personal"></canvas>
            </div>
        </div>
    </div>

    <script>
        // â˜…æ–°ã—ã„GASã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzhvm7kvgLWYsGFEBuTvyXSMC0PXM-X7RrYwL2Ta__JHU-EsGTldCr04ZnKPb6VFgzL/exec"; 

        let rawLogs = [];
        let personalChart = null; // ã‚°ãƒ©ãƒ•å†æç”»ç”¨

        async function fetchData() {
            const pass = document.getElementById('password').value;
            if(!pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            document.getElementById('loading').style.display = 'block';
            
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getLogs', password: pass })
                });
                const json = await res.json();
                if (json.error) {
                    alert("ã‚¨ãƒ©ãƒ¼: " + json.error);
                } else {
                    rawLogs = json.logs.slice(1).map(row => ({
                        time: new Date(row[0]),
                        name: row[1],
                        type: row[2]
                    }));
                    rawLogs.sort((a, b) => a.time - b.time); // å¤ã„é †
                    initDashboard();
                }
            } catch (e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); console.error(e);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function initDashboard() {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'flex';
            renderStatusBoard();
            renderDailyChart();
        }

        // 1. ãƒ‘ãƒãƒ«ç”Ÿæˆ
        function renderStatusBoard() {
            const userStatus = {};
            rawLogs.forEach(log => {
                userStatus[log.name] = { type: log.type, lastTime: log.time };
            });

            const grid = document.getElementById('status-grid');
            grid.innerHTML = "";
            Object.keys(userStatus).forEach(name => {
                const info = userStatus[name];
                const isWorking = info.type === 'å‡ºå‹¤';
                const timeStr = info.lastTime.getHours().toString().padStart(2, '0') + ":" + 
                                info.lastTime.getMinutes().toString().padStart(2, '0');

                const card = document.createElement('div');
                card.className = `user-card ${isWorking ? 'active' : ''}`;
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                card.onclick = () => showUserDetail(name);
                
                card.innerHTML = `
                    <div class="name">${name}</div>
                    <div class="status">${isWorking ? 'â— å‹¤å‹™ä¸­' : 'é€€å‹¤æ¸ˆã¿'}</div>
                    <div class="last-time">Last: ${timeStr}</div>
                `;
                grid.appendChild(card);
            });
        }

        // 2. å€‹äººè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showUserDetail(name) {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('modal-name').innerText = name;

            // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦æ•´å½¢
            const thisMonth = new Date().getMonth();
            const userLogs = rawLogs.filter(l => l.name === name && l.time.getMonth() === thisMonth);

            // ã€Œå‡ºå‹¤ã€ã¨ã€Œé€€å‹¤ã€ã‚’ãƒšã‚¢ãƒªãƒ³ã‚°ã—ã¦å‹¤å‹™æ™‚é–“ã‚’ç®—å‡º
            const workData = []; // [{ x: "1æ—¥", y: [9.0, 18.0] }, ...]
            let totalHours = 0;
            let tempStart = null;

            userLogs.forEach(log => {
                const day = log.time.getDate() + "æ—¥";
                const hourVal = log.time.getHours() + (log.time.getMinutes() / 60);

                if (log.type === 'å‡ºå‹¤') {
                    tempStart = hourVal;
                } else if (log.type === 'é€€å‹¤' && tempStart !== null) {
                    // ãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ (é–‹å§‹æ™‚é–“, çµ‚äº†æ™‚é–“)
                    workData.push({ x: day, y: [tempStart, hourVal] });
                    totalHours += (hourVal - tempStart);
                    tempStart = null;
                }
            });

            // åˆè¨ˆæ™‚é–“ã®è¡¨ç¤º
            document.getElementById('modal-summary').innerText = `ä»Šæœˆã®å‹¤å‹™åˆè¨ˆ: ${totalHours.toFixed(1)} æ™‚é–“`;

            // ã‚°ãƒ©ãƒ•æç”»
            const ctx = document.getElementById('chart-personal').getContext('2d');
            if (personalChart) personalChart.destroy();

            personalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: workData.map(d => d.x),
                    datasets: [{
                        label: 'å‹¤å‹™æ™‚é–“å¸¯',
                        data: workData, // æµ®å‹•æ£’ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ [é–‹å§‹, çµ‚äº†]
                        backgroundColor: '#00d26a',
                        borderRadius: 50,
                        barPercentage: 0.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // æ¨ªæ£’ã‚°ãƒ©ãƒ•ã«ã™ã‚‹
                    scales: {
                        x: { 
                            min: 0, max: 24, 
                            title: { display: true, text: 'æ™‚åˆ» (0æ™‚ã€œ24æ™‚)' },
                            ticks: { stepSize: 2 } 
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const raw = context.raw; // [start, end]
                                    const start = Math.floor(raw.y[0]) + ":" + Math.round((raw.y[0]%1)*60).toString().padStart(2,'0');
                                    const end = Math.floor(raw.y[1]) + ":" + Math.round((raw.y[1]%1)*60).toString().padStart(2,'0');
                                    return `${start} ã€œ ${end}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // 3. å…¨ä½“ã‚°ãƒ©ãƒ• (æ—¥åˆ¥å‡ºå‹¤è€…æ•°)
        function renderDailyChart() {
            const dailyCounts = {};
            rawLogs.forEach(log => {
                if (log.type === 'å‡ºå‹¤') {
                    const k = (log.time.getMonth()+1) + "/" + log.time.getDate();
                    dailyCounts[k] = (dailyCounts[k] || 0) + 1;
                }
            });
            const labels = Object.keys(dailyCounts).slice(-7);
            
            new Chart(document.getElementById('chart-daily'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‡ºå‹¤äººæ•°',
                        data: labels.map(l => dailyCounts[l]),
                        backgroundColor: '#3498db'
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function downloadCSV() {
            // å‰ã¨åŒã˜ã‚³ãƒ¼ãƒ‰ãªã®ã§çœç•¥ãªã—ã§ãã®ã¾ã¾ä½¿ã†
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            const header = ["æ—¥æ™‚", "æ°å", "ç¨®åˆ¥"]; 
            csvContent += header.join(",") + "\r\n";

            rawLogs.forEach(row => {
                const timeStr = row.time.toLocaleString();
                const line = `"${timeStr}","${row.name}","${row.type}"`;
                csvContent += line + "\r\n";
            });

            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            const today = new Date().toISOString().slice(0,10);
            link.download = `å‹¤æ€ è©³ç´°_${today}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
