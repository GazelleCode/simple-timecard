<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 1.5rem; color: #2c3e50; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-area { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; max-width: 400px; margin: 50px auto; }
        input[type="password"] { padding: 12px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 6px; width: 60%; margin-bottom: 15px; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #dashboard { display: none; }
        
        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š */
        .section-title { font-size: 1.2rem; font-weight: bold; margin: 30px 0 15px; border-left: 5px solid #2c3e50; padding-left: 10px; }
        
        /* 1. ç¾åœ¨ã®çŠ¶æ³ãƒ‘ãƒãƒ« */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .user-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; position: relative; border-bottom: 4px solid #ccc; }
        .user-card.active { border-bottom-color: #00d26a; } /* å‡ºå‹¤ä¸­ã¯ç·‘ */
        .user-card .name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .user-card .status { font-size: 0.85rem; color: #888; }
        .user-card.active .status { color: #00d26a; font-weight: bold; }
        .last-time { font-size: 0.75rem; color: #aaa; margin-top: 5px; }

        /* 2. ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        @media (max-width: 768px) { .charts-container { grid-template-columns: 1fr; } }

        /* ãƒœã‚¿ãƒ³ */
        button { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-download { background: #3498db; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        
        /* ãƒ­ãƒ¼ãƒ‰è¡¨ç¤º */
        #loading { display: none; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>å‹¤æ€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <button id="downloadBtn" class="btn-download" style="display:none;" onclick="downloadCSV()">
                <span>ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›</span>
            </button>
        </header>

        <div id="login-area">
            <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</p>
            <input type="password" id="password" placeholder="Password">
            <br>
            <button onclick="fetchData()">ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
            <div id="loading">å–å¾—ä¸­...</div>
        </div>

        <div id="dashboard">
            
            <div class="section-title">ç¾åœ¨ã®å‡ºå‹¤çŠ¶æ³</div>
            <div id="status-grid" class="status-grid">
                </div>

            <div class="charts-container">
                <div class="chart-box">
                    <canvas id="chart-daily"></canvas> </div>
                <div class="chart-box">
                    <canvas id="chart-ranking"></canvas> </div>
            </div>

        </div>
    </div>

    <script>
        // â˜…ã“ã“ã«ã•ã£ãå–å¾—ã—ãŸæ–°ã—ã„Web app URLã‚’è²¼ã‚‹ï¼ˆé‡è¦ï¼ï¼‰
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyDv4ESlQTkjdxXH0IhstdPqADHa36179GR3bE1W32YnaYFQkAdh5nvHmxf87-BbgXY/exec"; 

        let rawLogs = []; // CSVç”¨ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ä¿æŒ

        async function fetchData() {
            const pass = document.getElementById('password').value;
            if(!pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            document.getElementById('loading').style.display = 'block';
            
            try {
                // GASã‹ã‚‰å…¨ãƒ­ã‚°ã‚’å–å¾—
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getLogs', password: pass })
                });
                const json = await res.json();

                if (json.error) {
                    alert("ã‚¨ãƒ©ãƒ¼: " + json.error);
                } else {
                    rawLogs = json.logs;
                    initDashboard(rawLogs);
                }
            } catch (e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„");
                console.error(e);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function initDashboard(data) {
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'flex';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(0è¡Œç›®)ã‚’é™¤å»ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«ã™ã‚‹
            const logs = data.slice(1).map(row => ({
                time: new Date(row[0]), // æ—¥æ™‚
                name: row[1],           // åå‰
                type: row[2]            // ç¨®åˆ¥ï¼ˆå‡ºå‹¤/é€€å‹¤ï¼‰
            }));

            // ãƒ­ã‚°ã‚’å¤ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå¿µã®ãŸã‚ï¼‰
            logs.sort((a, b) => a.time - b.time);

            renderStatusBoard(logs);
            renderCharts(logs);
        }

        // 1. ã€Œä»Šèª°ãŒã„ã‚‹ï¼Ÿã€ãƒœãƒ¼ãƒ‰ã®æç”»
        function renderStatusBoard(logs) {
            const userStatus = {}; // { "ç”°ä¸­": { type: "å‡ºå‹¤", time: ... } }

            // ãƒ­ã‚°ã‚’èµ°æŸ»ã—ã¦ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œæœ€æ–°ã®çŠ¶æ…‹ã€ã‚’ç‰¹å®šã™ã‚‹
            logs.forEach(log => {
                userStatus[log.name] = {
                    type: log.type,
                    lastTime: log.time
                };
            });

            const grid = document.getElementById('status-grid');
            grid.innerHTML = "";

            Object.keys(userStatus).forEach(name => {
                const info = userStatus[name];
                const isWorking = info.type === 'å‡ºå‹¤';
                
                // æ™‚é–“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ä¾‹: 10:05)
                const timeStr = info.lastTime.getHours().toString().padStart(2, '0') + ":" + 
                                info.lastTime.getMinutes().toString().padStart(2, '0');

                // ã‚«ãƒ¼ãƒ‰HTMLç”Ÿæˆ
                const card = document.createElement('div');
                card.className = `user-card ${isWorking ? 'active' : ''}`;
                card.innerHTML = `
                    <div class="name">${name}</div>
                    <div class="status">${isWorking ? 'â— å‹¤å‹™ä¸­' : 'é€€å‹¤æ¸ˆã¿'}</div>
                    <div class="last-time">Last: ${timeStr}</div>
                `;
                grid.appendChild(card);
            });
        }

        // 2. ã‚°ãƒ©ãƒ•ã®æç”»
        function renderCharts(logs) {
            // --- A. æ—¥åˆ¥å‡ºå‹¤äººæ•° (ç›´è¿‘7æ—¥) ---
            const dailyCounts = {};
            logs.forEach(log => {
                if (log.type === 'å‡ºå‹¤') {
                    const dateKey = log.time.toLocaleDateString(); // "2024/01/03"
                    dailyCounts[dateKey] = (dailyCounts[dateKey] || 0) + 1;
                }
            });

            // ç›´è¿‘ã®æ—¥ä»˜é †ã«ä¸¦ã¹ã‚‹
            const sortedDates = Object.keys(dailyCounts).sort().slice(-7); 
            const dailyData = sortedDates.map(d => dailyCounts[d]);

            new Chart(document.getElementById('chart-daily'), {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'æ—¥åˆ¥ å‡ºå‹¤è€…æ•°',
                        data: dailyData,
                        backgroundColor: '#3498db',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, plugins: { title: { display: true, text: 'ç›´è¿‘ã®å‡ºå‹¤æ¨ç§»' } } }
            });

            // --- B. å€‹äººåˆ¥ å‡ºå‹¤å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
            const userCounts = {};
            logs.forEach(log => {
                if (log.type === 'å‡ºå‹¤') {
                    userCounts[log.name] = (userCounts[log.name] || 0) + 1;
                }
            });

            // å›æ•°ãŒå¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedUsers = Object.keys(userCounts).sort((a, b) => userCounts[b] - userCounts[a]);
            const rankingData = sortedUsers.map(u => userCounts[u]);

            new Chart(document.getElementById('chart-ranking'), {
                type: 'bar',
                data: {
                    labels: sortedUsers,
                    datasets: [{
                        label: 'ç´¯è¨ˆå‡ºå‹¤å›æ•°',
                        data: rankingData,
                        backgroundColor: '#2ecc71',
                        borderRadius: 5
                    }]
                },
                options: { 
                    indexAxis: 'y', // æ¨ªæ£’ã‚°ãƒ©ãƒ•ã«ã™ã‚‹
                    responsive: true, 
                    plugins: { title: { display: true, text: 'ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ å‡ºå‹¤æ•°' } } 
                }
            });
        }

        // 3. CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadCSV() {
            if (rawLogs.length === 0) return;
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
            
            rawLogs.forEach(row => {
                const rowStr = row.map(e => `"${e}"`).join(",");
                csvContent += rowStr + "\r\n";
            });

            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            const today = new Date().toISOString().slice(0,10);
            link.download = `å‹¤æ€ è©³ç´°ãƒ‡ãƒ¼ã‚¿_${today}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
